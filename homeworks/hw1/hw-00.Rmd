
---
title: "Homework 0: Record linkage of business records for a community pantry"
author: "Olivier Binette and Rebecca C. Steorts, STA 490/690"
output: 
     pdf_document:
      includes: 
          in_header: custom2.tex
font-size: 8px
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

if (!require(pacman)) install.packages("pacman")
pacman::p_load(dplyr, kable, kableExtra)
```

***General instructions for homeworks***: Please follow the uploading file instructions according to the syllabus. Your code must be completely reproducible and must compile. 

***Advice***: Start early on the homeworks and it is advised that you not wait until the day of as these homeworks are meant to be longer and treated as case studies.

***Commenting code***
Code should be commented. See the Google style guide for questions regarding commenting or how to write 
code \url{https://google.github.io/styleguide/Rguide.xml}. No late homework's will be accepted.

***R Markdown Test***

0. Open a new R Markdown file; set the output to HTML mode and "Knit". This should produce a web page with the knitting procedure executing your code blocks. You can edit this new file to produce your homework submission.

\textbf{Total points on assignment: 5 (reproducibility) + 10 points for the assignment.}

\newpage

# 1. Introduction

A community pantry located in Durham, North Carolina\footnote{The pantry has allowed the use of their anonymized data for this case study but has requested not to be named.} provides food and basic necessities to Duke University graduate students in need of assistance. Since the beginning of the COVID-19 pandemic, pantry usage consists of a weekly bagging program. Specifically, students fill out food orders through an online Qualtrics survey. The pantry bag are then delivered to their residence or ready for pick-up at the pantry on the next Saturday. The pantry bags typically contain canned beans, canned fruits and vegetables, cereals, rice, flour, and other basic necessities such as diapers (or needs for families with small children). 

Today, you are a volunteer statistician at the pantry! 

You have been tasked to do the following: 

- describe the composition of pantry users through bag order records (see section 2), where each bag order record represents a food bag that was given to a student. 
- provide recommendations regarding how the pantry could improve its data collection efforts to better evaluate the need of students.

Your analysis will assist the pantry in its negotiation with university stakeholders and will help them prepare for an upcoming symposium on the subject of food insecurity with other colleges in the United States. 

In order to describe the composition of pantry users, you will perform the following three tasks:

1. perform deterministic record linkage on the anonymized pantry data;

2. construct representative records for individual pantry users identified in (1); and

3. report summary statistics based on (2).

The tasks are outlined in more detail in section 3.

# 2. Data

The pantry's bag order records consists of bag orders filled between June 24 and November 4 2020 through an online Qualtrics form. Each record contains a date, name, phone number, email, physical address, the requested food order for the week and the answers to a few background questions. This is summarized in Table 1.

\begin{table}[ht]
\centering
\begin{tabular}{r|ll}
	\toprule
	Question no. & Question & Answer form\\
	\midrule
	\multirow{3}{*}{Identifiers $\left\{\begin{array}{l}2\\3\\4\end{array}\right.$}& First name and last initial & Free form\\
	& Duke email & Free form\\
	& Phone number & Free form\\
	\multirow{6}{*}{Order $\left\{\begin{array}{r}5\\6-7\\8\\9\\10\\11-29\end{array}\right.$}& Delivery or Pickup? & Multiple choices\\
	& Adress and delivery instructions & Free form\\
	& Food allergies & Free form\\
	& Number of members in household & 1-2 or 3+\\
	& Want baby bag? & Yes or no\\
	& Order items & Multiple choices\\
	\multirow{7}{*}{Survey $\left\{\begin{array}{l}30\\31\\32\\33\\34\\35\\36\end{array}\right.$}& Degree & Multiple choices or Other\\
	& School & Multiple choices or Other\\
	& Year in graduate school & Multiple choices\\
	& Number of adults in household & Multiple choices\\
	& Number of children in household & Multiple choices\\
	& Main challenges accessing food & Multiple choices or Other\\
	& Feedback & Free form\\

	\bottomrule
\end{tabular}
\label{table:survey_description}
\caption{Summary of the Qualtrics "Weekly Grocery Bag Request Survey" questions. Note that number of sub-questions which are not relevant to this analysis have been omitted.}
\end{table}

\paragraph{Protecting privacy of users.}

The data collected by the pantry about its users is private and confidential given it contains sensitive information about the Duke community. For example, a Duke student may not wish others to know that they are using the pantry. The purpose of this databse is fulfilling orders and helping the greater community in a time of need and crisis. In addition, we are using this to help the pantry improve its operations and services. 

Thus, for the purpose of this homework, the pantry has agreed to share an anonymized subset of the bag order records. The anonymization procedure (see file `encrypt_responses.R`) ensures that no private information is shared and that it is highly unlikely that any individual pantry user could be re-identified through cryptographic or linkage attacks. Specifically, the personal identifiers `name`, `phone` and `email` have been encrypted using an MD5 hash function. Furthermore, only the non free-form survey answers (questions 30-34) have been provided to you for your analysis. 

The anonymized data is contained in the file `order_data.rds` which will be individual provided to you in a private github repository. ***Make sure to not put this data set on any public repository and make sure not to share the data with anyone!***

# 3. Methodology

Many pantry users have filed more than one order in the considered time period. First, you will resolve individual pantry users using the pantry data set. Second, you will consolidate survey answers for each individual in the pantry. Finally, you will provide summary statistics and provide recommendations regarding the pantry's data collection efforts. In order to do this, you will perform three tasks below! 

## Task 1: record linkage

The features  `name`, `phone` and `email` may have variations, such as variants in spelling of first and last name. For example, one user may enter the first name "Olivier" or "Oliver" by accident. As another example, this same user may have multiple email addresses such as \url{olivier.binette@duke.edu} and \url{ob37@duke.edu}. The user may decide to use both email addresses at random. Finally, the pantry user may have both a cell number or a landline, and thus, you may observe different `phone` numbers for the same user. 

Your first task is to identify unique individuals who filed bag orders during the considered time period. To do this, perform **deterministic record linkage** using the three fields `name`, `phone` and `email` and define two records to be a match if they agree on at least one of these fields. Given your deterministic record linkage, assign a unique entity identifier to each pantry user.

For example, the following two records should be linked since they agree on email and phone number.

```{r, echo=FALSE}
data = readRDS("order_data.rds")
data[c(63, 190), ] %>% 
  mutate(name = paste0(substr(name, 1, 5), "..."),
         email = paste0(substr(email, 1, 5), "..."),
         phone = paste0(substr(phone, 1, 5), "..."),
         how = paste0(substr(how, 1, 6))) %>% 
  kable(booktabs=TRUE) %>% 
  kable_styling(font_size = 7)
```

You may use the guide provided in the appendix to help with this task. Any correct solution will be accepted.

## Task 2: canonicalization

Construct a data frame where each **row represents a unique pantry user** and with **columns `degree` and `school`**, where each entry is a representative answer for this individual. For example, you can choose the representative answer to be the first non NA answer for this individual.

The first three records of this data frame could look like this:

\begin{center}
\begin{tabular}{rll}
\toprule
uniqueID & degree & school\\
\midrule
1 & Master's & Fuqua School of Business\\
2 & Master's & Graduate School\\
3 & Master's & Fuqua School of Business\\
\bottomrule
\end{tabular}
\end{center}

You may use the guide provided in the appendix to help with this task. Any correct solution will be accepted.

## Task 3: summary statistics

Given the above, answer the following questions:

1. How many distinct individuals used the pantry? On average, how many orders has each user placed in the considered time period? How many individuals used the pantry only once?

2. Plot the distribution of the number of visits per pantry user.

3. What is the composition of degree type (Masters, PhD, etc) and school (Graduate School, Nicholas School, etc) among pantry users? Report the proportions using pie charts and use your best judgment if the categories need to be cleaned up.

Furthermore, discuss the following: How could the pantry improve its data collection efforts in order to gain more meaningful insights into its users and their needs? Keep in mind the need to protect the privacy of the pantry users.

\newpage
\appendix

\section{Appendix}

\subsection{Guide to task 1}

**Part a)** Read-in the encrypted data `order_data.rds` and view it using the function `View()`. How many non-empty orders were placed in the considered time period?

**Part b)** Construct a function `linkage_rule(A, B)` which returns `TRUE` if the record number `A` matches record number `B` on any of the fields `name`, `phone` or `email`.

**Part c)** Enumerate all possible record pairs using `pairs = t(combn(1:nrow(data), 2))`. Apply the function `linkage_rule` to each pair in order to determine if they match and store the result in a vector named `matches`. This might take a few minutes to run.


**Part d)** Construct a matrix with two columns, where each row is a pair of two matching record numbers. Make sure that each record is matching itself and that you remove NA values. This is called an edge list.

**Part e)** Use the function `igraph::graph_from_edgelist()` to construct a linkage graph based on the edge list. Then use `igraph::components()` to find connected components and assign unique entity identifiers. Hint: use `igraph::components(g)$membership`.

**Part f)** Add a column to the data with the unique entity identifiers. How many distinct individuals visited the pantry in the considered time period?


**Part g)** (Optional challenge) Can you perform the record linkage much more efficiently, without enumerating all record pairs? Hint: use sorting.

\subsection{Guide to task 2}

**Part a)** Write a function `first_non_na()` which returns the first non-NA entry of a vector or otherwise returns "NA".

**Part b)** Construct a data frame where each row represent a unique pantry user and each column is the first non-NA data entry for this person. Hint: group `data` by unique ID and use the function `dplyr::summarize_all()` to summarize each column using the `first_non_na()` function.
